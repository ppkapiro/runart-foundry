name: IA-Visual Analysis

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Modo de ejecuciÃ³n'
        required: true
        default: 'list'
        type: choice
        options:
          - list
          - generate-visual
          - generate-text
          - correlate-all
      image_dir:
        description: 'Directorio de imÃ¡genes (para generate-visual)'
        required: false
        default: 'content/media'
      wp_json_url:
        description: 'URL WordPress REST API (para generate-text)'
        required: false
        default: 'https://runartfoundry.com/wp-json/runart/audit/pages'
      threshold:
        description: 'Umbral de similitud (para correlate-all)'
        required: false
        default: '0.70'
      top_k:
        description: 'Top K recomendaciones (para correlate-all)'
        required: false
        default: '5'

jobs:
  ia-visual-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Instalar dependencias base
          pip install sentence-transformers==2.7.0
          pip install torch==2.3.1 --index-url https://download.pytorch.org/whl/cpu
          pip install pillow==10.3.0
          pip install scikit-learn==1.4.2
          pip install requests
      
      - name: ðŸ“‹ List embeddings (mode: list)
        if: ${{ inputs.mode == 'list' }}
        run: |
          echo "=== Embeddings Visuales ==="
          if [ -d "data/embeddings/visual/clip_512d/embeddings" ]; then
            ls -lh data/embeddings/visual/clip_512d/embeddings/ | wc -l
            echo "archivos encontrados"
          else
            echo "âš ï¸ Directorio no existe"
          fi
          
          echo ""
          echo "=== Embeddings Textuales ==="
          if [ -d "data/embeddings/text/multilingual_mpnet/embeddings" ]; then
            ls -lh data/embeddings/text/multilingual_mpnet/embeddings/ | wc -l
            echo "archivos encontrados"
          else
            echo "âš ï¸ Directorio no existe"
          fi
          
          echo ""
          echo "=== Correlaciones ==="
          if [ -f "data/embeddings/correlations/similarity_matrix.json" ]; then
            echo "âœ… similarity_matrix.json existe"
          else
            echo "âš ï¸ similarity_matrix.json no existe"
          fi
          
          if [ -f "data/embeddings/correlations/recommendations_cache.json" ]; then
            echo "âœ… recommendations_cache.json existe"
          else
            echo "âš ï¸ recommendations_cache.json no existe"
          fi
      
      - name: ðŸ–¼ï¸ Generate visual embeddings (mode: generate-visual)
        if: ${{ inputs.mode == 'generate-visual' }}
        run: |
          echo "ðŸš€ Generando embeddings visuales desde: ${{ inputs.image_dir }}"
          if [ -d "${{ inputs.image_dir }}" ]; then
            python apps/runmedia/runmedia/vision_analyzer.py \
              --image-dir "${{ inputs.image_dir }}"
          else
            echo "âš ï¸ Directorio ${{ inputs.image_dir }} no existe"
            echo "â„¹ï¸ Ejecutando en modo stub (sin imÃ¡genes reales)"
            python apps/runmedia/runmedia/vision_analyzer.py --help
          fi
      
      - name: ðŸ“ Generate text embeddings (mode: generate-text)
        if: ${{ inputs.mode == 'generate-text' }}
        run: |
          echo "ðŸš€ Generando embeddings textuales desde: ${{ inputs.wp_json_url }}"
          python apps/runmedia/runmedia/text_encoder.py \
            --wp-json-url "${{ inputs.wp_json_url }}" || true
      
      - name: ðŸ§® Calculate correlations (mode: correlate-all)
        if: ${{ inputs.mode == 'correlate-all' }}
        run: |
          echo "ðŸš€ Calculando correlaciones (threshold=${{ inputs.threshold }}, top_k=${{ inputs.top_k }})"
          python apps/runmedia/runmedia/correlator.py \
            --threshold ${{ inputs.threshold }} \
            --top-k ${{ inputs.top_k }}
      
      - name: ðŸ“Š Generate summary report
        run: |
          echo "=== ðŸ“‹ REPORTE DE ANÃLISIS IA-VISUAL ==="
          echo ""
          echo "Modo de ejecuciÃ³n: ${{ inputs.mode }}"
          echo "Fecha/Hora: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo ""
          
          # Contar embeddings
          VISUAL_COUNT=0
          TEXT_COUNT=0
          
          if [ -d "data/embeddings/visual/clip_512d/embeddings" ]; then
            VISUAL_COUNT=$(find data/embeddings/visual/clip_512d/embeddings -name "*.json" 2>/dev/null | wc -l)
          fi
          
          if [ -d "data/embeddings/text/multilingual_mpnet/embeddings" ]; then
            TEXT_COUNT=$(find data/embeddings/text/multilingual_mpnet/embeddings -name "*.json" 2>/dev/null | wc -l)
          fi
          
          echo "Embeddings visuales: $VISUAL_COUNT"
          echo "Embeddings textuales: $TEXT_COUNT"
          echo ""
          
          # Estado de correlaciones
          if [ -f "data/embeddings/correlations/recommendations_cache.json" ]; then
            echo "âœ… Cache de recomendaciones disponible"
            PAGES_WITH_RECS=$(python -c "import json; d=json.load(open('data/embeddings/correlations/recommendations_cache.json')); print(sum(1 for v in d['cache'].values() if v))" 2>/dev/null || echo "N/A")
            echo "   PÃ¡ginas con recomendaciones: $PAGES_WITH_RECS"
          else
            echo "âš ï¸ Cache de recomendaciones no disponible"
            echo "   Ejecutar: python apps/runmedia/runmedia/correlator.py"
          fi
          
          echo ""
          echo "=== FIN DEL REPORTE ==="
      
      - name: ðŸ’¾ Upload embeddings as artifacts (if generated)
        if: ${{ inputs.mode != 'list' }}
        uses: actions/upload-artifact@v4
        with:
          name: embeddings-${{ inputs.mode }}-${{ github.run_number }}
          path: |
            data/embeddings/
          retention-days: 7
      
      - name: âœ… Summary
        run: |
          echo "### IA-Visual Analysis Complete ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ inputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Phase:** F7 â€” Arquitectura IA-Visual" >> $GITHUB_STEP_SUMMARY
